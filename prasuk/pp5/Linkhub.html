<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eduinthai Linkhub</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; margin: 0; display: flex; justify-content: center; align-items: flex-start; padding: 20px 10px; min-height: 100vh; box-sizing: border-box; }
        .background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://lh3.googleusercontent.com/d/1zRGrwm32YUgg2UIeMERFwx5iQnfcAvp4'); background-size: cover; background-position: center; z-index: -1; }
        .logo { width: 130px; margin-bottom: 15px; }
        h2 { margin-bottom: 5px; color: #333; font-size: 22px; }
        h5 { margin-top: 5px; margin-bottom: 15px; color: #555; font-weight: 400; }
        .main-container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); text-align: center; width: 400px; max-width: 95%; z-index: 1; position: relative; }
        .hidden { display: none !important; }
        .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
        #search-box { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-family: 'Sarabun', sans-serif; font-size: 16px; }
        #search-btn { flex-shrink: 0; padding: 12px 20px; }
        .service-container { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .service-column { display: flex; flex-direction: column; gap: 10px; }
        .column-header { font-size: 18px; font-weight: 600; color: #444; margin-bottom: 5px; text-align: left; }
        .service-button { background-color: #f0f0f0; color: #333; border: 1px solid #ddd; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 15px; font-family: 'Sarabun', sans-serif; transition: background-color 0.3s, transform 0.2s; width: 100%; text-align: left; }
        .service-button:hover { background-color: #e0e0e0; transform: translateY(-1px); }
        .login-form-section label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; text-align: center; }
        #password { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        #error-message, #error-message-2fa { color: #e74c3c; font-size: 14px; margin-bottom: 15px; min-height: 20px; text-align: center; }
        button { background-color: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-family: 'Sarabun', sans-serif; transition: background-color 0.3s, transform 0.2s; }
        button:hover { background-color: #2980b9; transform: translateY(-2px); }
        #submit-password { width: 100%; padding: 12px 20px; }
        #pin-container { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .pin-input { width: 45px; height: 50px; text-align: center; font-size: 24px; border: 1px solid #ccc; border-radius: 6px; }
        #pattern-container { display: flex; flex-direction: column; align-items: center; margin: 10px 0; }
        #pattern-canvas { border: 1px solid #ddd; border-radius: 8px; cursor: pointer; }
        #reset-pattern-btn { margin-top: 15px; background-color: #e74c3c; width: 100%; padding: 12px 20px;}
        #iframe-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .loader { border: 16px solid #f3f3f3; border-top: 16px solid #3498db; border-radius: 50%; width: 120px; height: 120px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #iframe { width: 100%; height: 100%; border: 0; }
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; border-radius: 12px; }
    </style>
</head>
<body>
    <div class="background"></div>

    <!-- คอนเทนเนอร์หลัก -->
    <div id="login-container" class="main-container">
        <div class="loading-overlay hidden">
            <div class="loader"></div>
            <p style="margin-top: 20px;">กำลังตรวจสอบข้อมูล...</p>
        </div>
        <img src="https://lh3.googleusercontent.com/d/1_yLLFZQNGOLofnjgEeW-P9NFxKVVvgWk" alt="Logo" class="logo">
        <h2>เลือกบริการ</h2>
        <h5>(บริการฟรี ไม่มีค่าใช้จ่าย)</h5>
        <div class="search-container">
            <input type="text" id="search-box" placeholder="ค้นหาบริการ..." autocomplete="off">
            <button id="search-btn">ค้นหา</button>
        </div>
        <div class="service-container"></div>
        <div class="login-form-section">
            <label for="password">หรือกรอกรหัสผ่าน:</label>
            <input type="password" id="password" required>
            <div id="error-message"></div>
            <button id="submit-password">ยืนยัน</button>
        </div>
    </div>

    <!-- คอนเทนเนอร์สำหรับ 2FA -->
    <div id="second-factor-container" class="main-container hidden">
        <img src="https://lh3.googleusercontent.com/d/1_yLLFZQNGOLofnjgEeW-P9NFxKVVvgWk" alt="Logo" class="logo">
        <h2>ยืนยันตัวตนขั้นที่สอง</h2>
        <h5>กรุณากรอก PIN หรือวาดรหัสแพทเทิร์น</h5>
        <div class="login-form-section">
            <label>กรอกรหัส PIN:</label>
            <div id="pin-container">
                <input type="text" class="pin-input" maxlength="1"><input type="text" class="pin-input" maxlength="1"><input type="text" class="pin-input" maxlength="1"><input type="text" class="pin-input" maxlength="1"><input type="text" class="pin-input" maxlength="1"><input type="text" class="pin-input" maxlength="1">
            </div>
        </div>
        <div class="login-form-section">
            <label>วาดรหัสแพทเทิร์น:</label>
            <div id="pattern-container">
                <canvas id="pattern-canvas" width="250" height="250"></canvas>
                <button id="reset-pattern-btn">วาดใหม่</button>
            </div>
        </div>
        <div id="error-message-2fa"></div>
    </div>

    <!-- คอนเทนเนอร์สำหรับ iframe -->
    <div id="iframe-container" class="hidden">
        <div class="loader"></div>
        <iframe id="iframe" style="display:none;"></iframe>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loginContainer = document.getElementById('login-container');
            const secondFactorContainer = document.getElementById('second-factor-container');
            const iframeContainer = document.getElementById('iframe-container');
            const iframe = document.getElementById('iframe');
            const passwordInput = document.getElementById('password');
            const submitPasswordBtn = document.getElementById('submit-password');
            const errorMessage = document.getElementById('error-message');
            const errorMessage2FA = document.getElementById('error-message-2fa');
            const pinInputs = document.querySelectorAll('.pin-input');
            const canvas = document.getElementById('pattern-canvas');
            const ctx = canvas.getContext('2d');
            const resetBtn = document.getElementById('reset-pattern-btn');
            const loadingOverlay = document.querySelector('#login-container .loading-overlay');
            
            let twoFactorData = {};

            function showIframe(encodedUrl) {
                loginContainer.classList.add('hidden');
                secondFactorContainer.classList.add('hidden');
                iframeContainer.classList.remove('hidden');
                iframeContainer.style.display = 'flex';
                
                try {
                    const iframeUrl = CryptoJS.enc.Base64.parse(encodedUrl).toString(CryptoJS.enc.Utf8);
                    if (iframeUrl) {
                        iframe.style.display = 'none'; // ซ่อน iframe ไว้ก่อน
                        iframe.onload = () => {
                            iframeContainer.querySelector('.loader').style.display = 'none'; // ซ่อนตัวโหลด
                            iframe.style.display = 'block'; // แสดง iframe
                        };
                        iframe.src = iframeUrl;
                    } else { throw new Error("Decoded URL is empty."); }
                } catch (e) { showLoginScreen("เกิดข้อผิดพลาดในการถอดรหัส URL"); }
            }

            function showLoginScreen(message) {
                iframeContainer.classList.add('hidden');
                secondFactorContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                errorMessage.textContent = message;
                passwordInput.value = '';
                window.scrollTo(0, 0);
            }

            function showSecondFactorScreen(data) {
                twoFactorData = data;
                loginContainer.classList.add('hidden');
                secondFactorContainer.classList.remove('hidden');
                errorMessage2FA.textContent = '';
                pinInputs.forEach(input => input.value = '');
                path = [];
                draw();
            }

            function submitFirstFactor(password) {
                loadingOverlay.classList.remove('hidden');
                errorMessage.textContent = '';
                const hashedInputPassword = CryptoJS.SHA256(password).toString();
                
                const scriptUrl = 'https://script.google.com/macros/s/AKfycbzs3cenPz_5SpxySUIcuhorHPhrzrdlLVAMFPUal_Kq1OsmkoXMwHyjlaZz5OXSHNMTMg/exec';

                fetch(scriptUrl, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `password=${hashedInputPassword}` })
                .then(response => response.json())
                .then(result => {
                    switch (result.status) {
                        case 'success': showIframe(result.url); break;
                        case '2fa_required': showSecondFactorScreen(result); break;
                        case 'invalid': showLoginScreen("รหัสผ่านไม่ถูกต้อง!"); break;
                        default: showLoginScreen(result.message || "เกิดข้อผิดพลาดไม่ทราบสาเหตุ"); break;
                    }
                })
                .catch(error => { showLoginScreen("เกิดข้อผิดพลาดในการเชื่อมต่อ"); })
                .finally(() => { loadingOverlay.classList.add('hidden'); });
            }

            function submitSecondFactor(secondPassword) {
                const hashedSecondPassword = CryptoJS.SHA256(secondPassword).toString();
                if (hashedSecondPassword === twoFactorData.pin || hashedSecondPassword === twoFactorData.pattern) {
                    showIframe(twoFactorData.url);
                } else {
                    errorMessage2FA.textContent = "PIN หรือรหัสแพทเทิร์นไม่ถูกต้อง!";
                    pinInputs.forEach(input => input.value = '');
                    path = [];
                    draw();
                }
            }

            submitPasswordBtn.addEventListener('click', () => { if (passwordInput.value) submitFirstFactor(passwordInput.value); });
            passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && passwordInput.value) submitFirstFactor(passwordInput.value); });
            pinInputs.forEach((input, index) => { input.addEventListener('input', () => { if (input.value.length === 1 && index < pinInputs.length - 1) { pinInputs[index + 1].focus(); } if (Array.from(pinInputs).every(i => i.value.length === 1)) { const pin = Array.from(pinInputs).map(i => i.value).join(''); submitSecondFactor(pin); } }); });
            
            let isDrawing = false, path = [], dots = [], dotRadius = 10, patternSize = 3;
            function setupCanvas() { dots.length = 0; const gapX = canvas.width / (patternSize + 1); const gapY = canvas.height / (patternSize + 1); for (let i = 0; i < patternSize; i++) { for (let j = 0; j < patternSize; j++) { dots.push({ x: gapX * (j + 1), y: gapY * (i + 1), id: i * patternSize + j + 1 }); } } draw(); }
            function draw() { ctx.clearRect(0, 0, canvas.width, canvas.height); dots.forEach(dot => { ctx.beginPath(); ctx.arc(dot.x, dot.y, dotRadius, 0, Math.PI * 2); ctx.fillStyle = path.includes(dot) ? '#3498db' : '#ccc'; ctx.fill(); }); if (path.length > 1) { ctx.beginPath(); ctx.moveTo(path[0].x, path[0].y); for(let i = 1; i < path.length; i++) { ctx.lineTo(path[i].x, path[i].y); } ctx.strokeStyle = '#3498db'; ctx.lineWidth = 3; ctx.stroke(); } }
            function getDotAt(x, y) { for (const dot of dots) { const dx = x - dot.x; const dy = y - dot.y; if (dx * dx + dy * dy < (dotRadius * 1.5) * (dotRadius * 1.5) ) { return dot; } } return null; }
            function getMousePos(e) { const rect = canvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: clientX - rect.left, y: clientY - rect.top }; }
            function startDraw(e) { e.preventDefault(); isDrawing = true; const pos = getMousePos(e); const dot = getDotAt(pos.x, pos.y); if (dot && !path.includes(dot)) { path.push(dot); } draw(); }
            function moveDraw(e) { if (!isDrawing) return; e.preventDefault(); const pos = getMousePos(e); const dot = getDotAt(pos.x, pos.y); if (dot && !path.includes(dot)) { path.push(dot); } draw(); }
            function endDraw() { if (isDrawing) { isDrawing = false; if (path.length > 0) { const pattern = path.map(d => d.id).join(''); submitSecondFactor(pattern); } } }
            canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', moveDraw); canvas.addEventListener('mouseup', endDraw); canvas.addEventListener('mouseleave', endDraw); canvas.addEventListener('touchstart', startDraw); canvas.addEventListener('touchmove', moveDraw); canvas.addEventListener('touchend', endDraw);
            resetBtn.addEventListener('click', () => { path = []; draw(); });
            setupCanvas();
            
            const serviceContainer = document.querySelector('.service-container');
            const searchBox = document.getElementById('search-box');
            const searchBtn = document.getElementById('search-btn');
            
            const services = {
                "เครื่องมือและระบบทั่วไป": [
                    { name: "ระบบสร้าง QRCode", pass: "qr" },
                    { name: "ระบบย่อลิ้งเว็บไซต์", pass: "url" },
                    { name: "ระบบฝากรูป", pass: "pic" }
                ],
                "ระบบข้อมูลเฉพาะ": [
                    { name: "ระบบข้อมูลนักเรียน", pass: "prasuk565565" }
                ]
            };

            Object.keys(services).forEach(category => { const column = document.createElement('div'); column.className = 'service-column'; const header = document.createElement('h2'); header.className = 'column-header'; header.textContent = category; column.appendChild(header); services[category].forEach(service => { const button = document.createElement('button'); button.className = 'service-button'; button.textContent = service.name; button.dataset.pass = service.pass; button.addEventListener('click', function() { submitFirstFactor(this.dataset.pass); }); column.appendChild(button); }); serviceContainer.appendChild(column); });
            
            function filterServices() {
                const searchTerm = searchBox.value.toLowerCase();
                document.querySelectorAll('.service-column').forEach(column => {
                    let hasVisibleButton = false;
                    column.querySelectorAll('.service-button').forEach(button => {
                        const buttonText = button.textContent.toLowerCase();
                        if (buttonText.includes(searchTerm)) {
                            button.style.display = 'block';
                            hasVisibleButton = true;
                        } else {
                            button.style.display = 'none';
                        }
                    });
                    column.style.display = hasVisibleButton ? 'flex' : 'none';
                });
            }

            // --- Final Definitive Search Handling ---

            // 1. Trigger search on button click.
            searchBtn.addEventListener('click', filterServices);

            // 2. Trigger search on pressing "Enter" in the search box.
            searchBox.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    filterServices();
                }
            });

            // 3. Set the initial state correctly on script load to show all services.
            searchBox.value = '';
            filterServices();

        });
    </script>
</body>
</html>
