<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงานผลการทดสอบวัดระดับ CEFR ภาษาอังกฤษ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        .filter-btn, .update-btn {
            transition: all 0.3s ease;
        }
        .filter-btn.active {
            background-color: #4338ca; /* indigo-700 */
            color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .card {
            background-color: white;
            border: 1px solid #e5e7eb; /* gray-200 */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        }
        .search-input {
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #d1d5db; /* gray-300 */
            color: #111827; /* gray-900 */
        }
        .search-input:focus {
            outline: none;
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
        /* Make charts clickable */
        canvas {
            cursor: pointer;
        }
    </style>
</head>
<body class="text-gray-800 p-4 sm:p-6 md:p-8">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex flex-col justify-center items-center z-50">
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-600"></div>
        <p class="mt-4 text-lg text-gray-700">กำลังโหลดข้อมูล...</p>
    </div>

    <div class="main-container max-w-7xl mx-auto p-4 sm:p-6 rounded-2xl">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">ระบบรายงานผลการทดสอบวัดระดับ CEFR ภาษาอังกฤษ</h1>
            <p class="text-lg text-gray-600">โรงเรียนบ้านประสุข ประจำปีการศึกษา 2568</p>
        </header>

        <!-- Update Button -->
        <div class="flex justify-center mb-6">
            <button id="update-data-btn" class="update-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md">
                อัปเดตข้อมูล
            </button>
        </div>
        
        <div id="error-display" class="my-4"></div>

        <!-- Filters -->
        <div class="flex flex-col md:flex-row gap-6 mb-6">
            <div class="flex-1 card p-4 rounded-xl">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">เลือกชั้นเรียน</h2>
                <div id="class-filter" class="flex flex-wrap gap-2">
                    <button data-filter-group="class" data-filter-value="ทั้งหมด" class="filter-btn active bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg">ทั้งหมด</button>
                    <button data-filter-group="class" data-filter-value="ป.4" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg">ป.4</button>
                    <button data-filter-group="class" data-filter-value="ป.5" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg">ป.5</button>
                    <button data-filter-group="class" data-filter-value="ป.6" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg">ป.6</button>
                    <button data-filter-group="class" data-filter-value="ม.1" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg">ม.1</button>
                    <button data-filter-group="class" data-filter-value="ม.2" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg">ม.2</button>
                    <button data-filter-group="class" data-filter-value="ม.3" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg">ม.3</button>
                </div>
            </div>
            <div class="flex-1 card p-4 rounded-xl">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">เลือกระดับการสอบ (CEFR)</h2>
                <div id="level-filter" class="flex flex-wrap gap-2">
                    <button data-filter-group="level" data-filter-value="ทั้งหมด" class="filter-btn active bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg">ทั้งหมด</button>
                    <button data-filter-group="level" data-filter-value="A1" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg">A1</button>
                </div>
            </div>
        </div>

        <!-- Top Dashboard Cards -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="lg:col-span-1 card bg-indigo-600 text-white p-6 rounded-xl flex flex-col justify-center items-center text-center">
                <h3 class="text-xl font-semibold text-indigo-100 mb-2">จำนวนนักเรียน</h3>
                <p id="student-count" class="text-6xl font-bold">0</p>
            </div>
            <div class="lg:col-span-2 card p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">ผลการวัดระดับ</h3>
                <div class="relative h-64 md:h-80">
                    <canvas id="resultsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Bar Charts for Score Distribution -->
        <div class="grid grid-cols-1 gap-6 mb-6">
            <div class="card p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">คะแนนรวม</h3>
                <div class="relative h-64">
                    <canvas id="totalScoreChart"></canvas>
                </div>
            </div>
            <div class="card p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">ทักษะการฟัง</h3>
                <div class="relative h-64">
                    <canvas id="listeningScoreChart"></canvas>
                </div>
            </div>
            <div class="card p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">ทักษะการพูด</h3>
                <div class="relative h-64">
                    <canvas id="speakingScoreChart"></canvas>
                </div>
            </div>
            <div class="card p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">ทักษะการอ่าน</h3>
                <div class="relative h-64">
                    <canvas id="readingScoreChart"></canvas>
                </div>
            </div>
            <div class="card p-6 rounded-xl">
                <h3 class="text-xl font-semibold text-gray-900 mb-4 text-center">ทักษะการเขียน</h3>
                <div class="relative h-64">
                    <canvas id="writingScoreChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Data Table -->
        <div class="card p-4 sm:p-6 rounded-xl">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                 <h3 class="text-xl font-semibold text-gray-900">รายละเอียดข้อมูลนักเรียน</h3>
                 <input type="text" id="table-search" class="search-input w-full sm:w-auto md:w-1/3 p-2 rounded-lg" placeholder="ค้นหาในตาราง...">
            </div>
             <div class="overflow-x-auto">
                <table id="student-table" class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100"></thead>
                    <tbody></tbody>
                </table>
             </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center mt-8 py-4">
        <a href="https://eduinthai.com/" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-indigo-600 transition-colors">
            ผู้พัฒนา นายกานตพงศ์ สุวรรณทา
        </a>
    </footer>

    <!-- Student List Modal -->
    <div id="student-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50 hidden">
        <div class="card w-11/12 md:w-2/3 lg:w-1/2 max-w-3xl max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h3 id="modal-title" class="text-xl font-semibold text-gray-900">รายชื่อนักเรียน</h3>
                <button id="modal-close-btn" class="text-3xl font-light text-gray-500 hover:text-gray-900">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto">
                <!-- Student list will be injected here -->
            </div>
        </div>
    </div>


    <script>
        // Register Chart.js datalabels plugin globally
        Chart.register(ChartDataLabels);

        const GAS_URL = 'https://script.google.com/macros/s/AKfycbx0NSQx5PL-vOEYCIWzxd-GF97LpwVLoL2l-iUXnW1c3lZq7Ts0J2D7hvC_yQFgQYx8/exec';

        let allData = [];
        let headers = [];
        let currentFilteredData = [];
        let doughnutChartInstance = null;
        let totalScoreChartInstance, listeningScoreChartInstance, speakingScoreChartInstance, readingScoreChartInstance, writingScoreChartInstance;
        
        const columnIndices = {
            prefix: 1,
            name: 2,
            class: 3, 
            listeningScore: 4, 
            speakingScore: 5, 
            readingScore: 6,
            writingScore: 7, 
            totalScore: 8, 
            result: 9, 
            level: 10
        };

        const studentCountEl = document.getElementById('student-count');
        const doughnutChartCanvas = document.getElementById('resultsChart');
        const tableHead = document.querySelector('#student-table thead');
        const tableBody = document.querySelector('#student-table tbody');
        const loadingOverlay = document.getElementById('loading-overlay');
        const errorDisplay = document.getElementById('error-display');
        const tableSearchInput = document.getElementById('table-search');
        const updateDataBtn = document.getElementById('update-data-btn');
        const studentModal = document.getElementById('student-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            setupEventListeners();
        });

        function showError(message) {
            const errorHtml = `<div class="bg-red-100 border border-red-400 text-red-700 p-4 rounded-lg text-center">${message}</div>`;
            errorDisplay.innerHTML = errorHtml;
        }

        async function fetchData() {
            try {
                loadingOverlay.style.display = 'flex';
                errorDisplay.innerHTML = '';
                const response = await fetch(GAS_URL);
                if (!response.ok) throw new Error(`เกิดข้อผิดพลาดจากเซิร์ฟเวอร์: ${response.statusText} (Status: ${response.status})`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                if (!Array.isArray(data) || data.length < 2) throw new Error('ไม่พบข้อมูลนักเรียนใน Google Sheet หรือข้อมูลมีรูปแบบไม่ถูกต้อง');
                headers = data[0];
                allData = data.slice(1);
                updateDashboard();
            } catch (error) {
                console.error('Fetch Error:', error);
                showError(`เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}. กรุณาตรวจสอบการตั้งค่า Deploy ของ Apps Script และลองอีกครั้ง`);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const container = e.target.closest('.flex-wrap');
                    const currentActive = container.querySelector('.active');
                    if(currentActive) {
                        currentActive.classList.remove('active', 'bg-indigo-700', 'text-white');
                        currentActive.classList.add('bg-gray-200', 'text-gray-800');
                    }
                    e.target.classList.add('active', 'bg-indigo-700', 'text-white');
                    e.target.classList.remove('bg-gray-200', 'text-gray-800');
                    updateDashboard();
                });
            });
            tableSearchInput.addEventListener('input', updateDashboard);
            updateDataBtn.addEventListener('click', fetchData);
            
            // Modal close events
            modalCloseBtn.addEventListener('click', () => studentModal.classList.add('hidden'));
            studentModal.addEventListener('click', (e) => {
                if (e.target === studentModal) {
                    studentModal.classList.add('hidden');
                }
            });
        }

        function getActiveFilters() {
            const classFilter = document.querySelector('#class-filter .active').dataset.filterValue;
            const levelFilter = document.querySelector('#level-filter .active').dataset.filterValue;
            const searchTerm = tableSearchInput.value.toLowerCase();
            return { classFilter, levelFilter, searchTerm };
        }

        function updateDashboard() {
            const { classFilter, levelFilter, searchTerm } = getActiveFilters();
            
            let filteredData = allData.filter(row => {
                if (!Array.isArray(row)) return false;
                const classMatch = (classFilter === 'ทั้งหมด') || (row[columnIndices.class] === classFilter);
                const levelMatch = (levelFilter === 'ทั้งหมด') || (row[columnIndices.level] === levelFilter);
                return classMatch && levelMatch;
            });

            if (searchTerm) {
                filteredData = filteredData.filter(row => row.some(cell => String(cell).toLowerCase().includes(searchTerm)));
            }
            
            currentFilteredData = filteredData; // Store current data for modal clicks

            studentCountEl.textContent = filteredData.length;
            updateDoughnutChart(filteredData);
            updateBarCharts(filteredData);
            updateTable(filteredData);
        }
        
        function handleChartClick(evt, elements, chart, filterType, scoreColumnIndex, scoreColumnName) {
            if (elements.length === 0) return;
            const elementIndex = elements[0].index;
            const clickedLabel = chart.data.labels[elementIndex];
            
            let studentsToShow = [];
            let modalTitleText = '';
            let scoreHeader = scoreColumnName;

            if (filterType === 'result') {
                studentsToShow = currentFilteredData.filter(row => row[columnIndices.result] === clickedLabel);
                modalTitleText = `ผลการวัดระดับ: ${clickedLabel}`;
            } else {
                const clickedScore = parseInt(clickedLabel, 10);
                studentsToShow = currentFilteredData.filter(row => parseInt(row[scoreColumnIndex], 10) === clickedScore);
                modalTitleText = `${scoreColumnName}: ${clickedScore} คะแนน`;
            }

            showStudentModal(modalTitleText, studentsToShow, scoreColumnIndex);
        }

        function showStudentModal(title, students, scoreColIdx) {
            modalTitle.textContent = title;
            
            if (students.length === 0) {
                modalBody.innerHTML = '<p class="text-center text-gray-500">ไม่พบข้อมูลนักเรียน</p>';
            } else {
                const scoreHeader = headers[scoreColIdx] || 'คะแนน';
                let tableHtml = `
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th class="px-4 py-3">ชื่อ-สกุล</th>
                                <th class="px-4 py-3">ชั้น</th>
                                <th class="px-4 py-3">${scoreHeader}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                students.forEach(student => {
                    const fullName = `${student[columnIndices.prefix]}${student[columnIndices.name]}`;
                    const studentClass = student[columnIndices.class];
                    const studentScore = student[scoreColIdx];
                    tableHtml += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-4 py-2">${fullName}</td>
                            <td class="px-4 py-2">${studentClass}</td>
                            <td class="px-4 py-2">${studentScore}</td>
                        </tr>
                    `;
                });
                tableHtml += '</tbody></table>';
                modalBody.innerHTML = tableHtml;
            }
            
            studentModal.classList.remove('hidden');
        }

        function updateDoughnutChart(data) {
            let resultCounts = data.reduce((acc, row) => {
                const result = row[columnIndices.result] || 'ไม่ระบุ';
                if (result && result.trim() !== '' && result !== 'ไม่ระบุ') {
                    acc[result] = (acc[result] || 0) + 1;
                }
                return acc;
            }, {});

            const labels = Object.keys(resultCounts);
            const counts = Object.values(resultCounts);
            
            const colorMap = {'Good': '#22c55e', 'Needs Improvement': '#f97316'};
            const backgroundColors = labels.map(label => colorMap[label] || '#6b7280');

            if (doughnutChartInstance) doughnutChartInstance.destroy();
            doughnutChartInstance = new Chart(doughnutChartCanvas, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: counts, backgroundColor: backgroundColors, borderColor: '#ffffff', borderWidth: 4 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '60%',
                    onClick: (evt, elements) => handleChartClick(evt, elements, doughnutChartInstance, 'result', columnIndices.result, 'ผลการวัดระดับ'),
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#4b5563', font: { size: 14, family: "'Sarabun', sans-serif" }, padding: 20 } },
                        tooltip: { enabled: true },
                        datalabels: {
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                if (sum === 0) return '0%';
                                return (value*100 / sum).toFixed(1) + "%";
                            },
                            color: '#fff', font: { weight: 'bold', size: 14, family: "'Sarabun', sans-serif" }
                        }
                    }
                }
            });
        }

        function createBarChart(canvasId, chartInstanceRef, data, scoreIndex, passingScore, scoreName) {
            const totalStudents = data.length;
            const scoreCounts = data.reduce((acc, row) => {
                const score = parseInt(row[scoreIndex], 10);
                if (!isNaN(score)) acc[score] = (acc[score] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(scoreCounts).sort((a, b) => a - b);
            const counts = labels.map(label => scoreCounts[label]);
            const maxCount = Math.max(...counts, 0);

            const passColor = '#22c55e'; // Green
            const failColor = '#ef4444'; // Red
            const backgroundColors = labels.map(label => parseInt(label, 10) >= passingScore ? passColor : failColor);

            if (chartInstanceRef) chartInstanceRef.destroy();
            
            const chart = new Chart(document.getElementById(canvasId), {
                type: 'bar',
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'จำนวนนักเรียน', 
                        data: counts, 
                        backgroundColor: backgroundColors, 
                        borderRadius: 4 
                    }] 
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (evt, elements) => handleChartClick(evt, elements, chart, 'score', scoreIndex, scoreName),
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                             callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = totalStudents > 0 ? (value / totalStudents * 100).toFixed(1) + '%' : '0%';
                                    return `จำนวน: ${value} คน (${percentage})`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end', align: 'top',
                            formatter: (value) => totalStudents > 0 ? (value*100 / totalStudents).toFixed(1) + "%" : '0%',
                            color: '#4b5563', font: { weight: 'bold', family: "'Sarabun', sans-serif" }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true, max: maxCount > 0 ? maxCount + 2 : 5,
                            title: { display: true, text: 'จำนวนนักเรียน', color: '#6b7280', font: { family: "'Sarabun', sans-serif" } },
                            ticks: { color: '#6b7280', font: { family: "'Sarabun', sans-serif" } },
                            grid: { color: '#e5e7eb' }
                        },
                        x: {
                            title: { display: true, text: 'คะแนน', color: '#6b7280', font: { family: "'Sarabun', sans-serif" } },
                            ticks: { color: '#6b7280', font: { family: "'Sarabun', sans-serif" } },
                            grid: { display: false }
                        }
                    }
                }
            });
            return chart;
        }

        function updateBarCharts(data) {
            const passMark = 5;
            totalScoreChartInstance = createBarChart('totalScoreChart', totalScoreChartInstance, data, columnIndices.totalScore, passMark, 'คะแนนรวม'); 
            listeningScoreChartInstance = createBarChart('listeningScoreChart', listeningScoreChartInstance, data, columnIndices.listeningScore, passMark, 'ทักษะการฟัง');
            speakingScoreChartInstance = createBarChart('speakingScoreChart', speakingScoreChartInstance, data, columnIndices.speakingScore, passMark, 'ทักษะการพูด');
            readingScoreChartInstance = createBarChart('readingScoreChart', readingScoreChartInstance, data, columnIndices.readingScore, passMark, 'ทักษะการอ่าน');
            writingScoreChartInstance = createBarChart('writingScoreChart', writingScoreChartInstance, data, columnIndices.writingScore, passMark, 'ทักษะการเขียน');
        }
        
        function updateTable(data) {
            tableHead.innerHTML = `<tr>${headers.map(h => `<th scope="col" class="px-6 py-3">${h}</th>`).join('')}</tr>`;
            tableBody.innerHTML = data.map(row => 
                `<tr class="bg-white border-b hover:bg-gray-50">
                    ${row.map(cell => `<td class="px-6 py-4">${cell}</td>`).join('')}
                </tr>`
            ).join('');
            
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center py-8 text-gray-500">ไม่พบข้อมูลที่ตรงกับตัวกรอง</td></tr>`;
            }
        }
    </script>
</body>
</html>
